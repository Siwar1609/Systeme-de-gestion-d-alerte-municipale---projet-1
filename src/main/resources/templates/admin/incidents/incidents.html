<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Liste des Incidents</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h2 {
            margin-bottom: 25px;
        }

        table th, table td {
            text-align: center;
            vertical-align: middle;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
        }

        .form-select-sm {
            font-size: 0.875rem;
        }

        .badge {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
    </style>
</head>

<body>
<div class="container mt-5">

    <h2>Liste des Incidents</h2>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <table class="table table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Titre</th>
            <th>Description</th>
            <th>Localisation</th>
            <th>Photos</th>
            <th>Citoyen</th>
            <th>Catégorie</th>
            <th>Priorité</th>
            <th>Statut</th>
            <th>Feedback Citoyen</th>
            <th>Agent</th>
            <th style="width: 30%;">Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="incident : ${incidents}">
            <td th:text="${incident.id}" class="text-center"></td>
            <td th:text="${incident.titre}"></td>
            <td th:text="${incident.description}"></td>
            <td>
                <span th:text="${incident.localisation}"></span><br/>
                <small class="text-muted"
                       th:text="'Lat : ' + ${incident.latitude} + ' / Lng : ' + ${incident.longitude}"></small>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-1" th:if="${incident.nomsPhotos != null}">
                    <img th:each="nom : ${#strings.arraySplit(incident.nomsPhotos, ';')}"
                         th:src="@{'/uploads/incidents/' + ${nom}}"
                         alt="Photo incident"
                         class="img-thumbnail"
                         style="max-height: 60px;">
                </div>
                <span th:if="${incident.nomsPhotos == null}">
        —
                           </span>
            </td>
            <td th:text="${incident.citoyen != null ? incident.citoyen.nom : '—'}"></td>

            <!-- Catégorie -->
            <td th:text="${incident.categorie != null ? incident.categorie.nom : '—'}"></td>

            <!-- Priorité -->
            <td>
                <span th:if="${incident.priorite != null}" class="badge bg-warning text-dark" th:text="${incident.priorite}"></span>
                <span th:if="${incident.priorite == null}" class="text-muted">Non définie</span>
            </td>

            <!-- Statut -->
            <td th:text="${incident.statut}"></td>
            <td>
                <div th:if="${incident.statut.name() == 'CLOTURE'}">
                    <div th:if="${incident.noteCitoyen != null}">
                        <strong th:text="${incident.noteCitoyen} + '/5'"></strong><br/>
                    </div>
                    <small class="text-muted"
                           th:if="${incident.feedbackCitoyen != null and !#strings.isEmpty(incident.feedbackCitoyen)}"
                           th:text="${incident.feedbackCitoyen}"></small>
                    <span class="text-muted"
                          th:if="${incident.noteCitoyen == null and (incident.feedbackCitoyen == null or #strings.isEmpty(incident.feedbackCitoyen))}">
            Aucun feedback
        </span>
                </div>
                <span class="text-muted"
                      th:if="${incident.statut.name() != 'CLOTURE'}">
        En attente du citoyen
    </span>
            </td>

            <!-- Agent -->
            <td th:text="${incident.agent != null ? incident.agent.nom : 'Non assigné'}"></td>

            <!-- Actions -->
            <td>
                <!-- Formulaire assignation agent -->
                <form th:action="@{/admin/incidents/assigner}" method="post" th:if="${incident.agent == null}" class="mb-2">
                    <input type="hidden" name="incidentId" th:value="${incident.id}">
                    <select name="agentId" class="form-select form-select-sm mb-1" required>
                        <option value="" disabled selected>-- Choisir agent --</option>
                        <option th:each="agent : ${agents}" th:value="${agent.id}" th:text="${agent.nom + ' (' + agent.service.nom + ')'}"></option>
                    </select>

                    <button type="submit" class="btn btn-primary btn-sm w-100">Assigner Agent</button>
                </form>

                <!-- Formulaire modification priorité -->
                <form th:action="@{/admin/incidents/modifierPriorite}" method="post" class="mb-2">
                    <input type="hidden" name="incidentId" th:value="${incident.id}">
                    <select name="priorite" class="form-select form-select-sm mb-1" required>
                        <option value="" disabled selected>-- Choisir priorité --</option>
                        <option th:each="p : ${T(com.example.demo.models.enums.PrioriteIncidentEnum).values()}" th:value="${p}" th:text="${p}"></option>
                    </select>
                    <button type="submit" class="btn btn-warning btn-sm w-100">Modifier Priorité</button>
                </form>

                <div th:if="${incident.agent != null}" class="text-success small text-center">
                    Agent déjà assigné
                </div>
            </td>
        </tr>

        <tr th:if="${#lists.isEmpty(incidents)}">
            <td colspan="9" class="text-center text-muted">
                Aucun incident enregistré.
            </td>
        </tr>
        </tbody>
    </table>

    <a th:href="@{/admin/dashboard}" class="btn btn-secondary mt-3">← Retour au dashboard</a>

</div>
</body>
</html>
