<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">Statistiques des incidents</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Important pour l’export PDF */
        #stats-content {
            background-color: white;
            padding: 20px;
        }
    </style>
</head>

<body>
<div class="container mt-4">

    <h2 class="mb-4" th:text="${pageTitle}">Statistiques des incidents</h2>

    <!-- ZONE À EXPORTER -->
    <div id="stats-content">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-chart-bar"></i> Incidents par catégorie
                    </div>
                    <div class="card-body">
                        <canvas id="categorieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-chart-pie"></i> Incidents par quartier
                    </div>
                    <div class="card-body">
                        <canvas id="quartierChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOUTONS -->
    <div class="mt-3">
        <a th:href="@{/admin/dashboard}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>

        <button class="btn btn-danger" onclick="exportPDF()">
            <i class="fas fa-file-pdf"></i> Exporter en PDF
        </button>
    </div>
</div>

<!-- LIBRAIRIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var categoriesData = /*[[${incidentsParCategorieJson}]]*/ {};
    var quartiersData = /*[[${incidentsParQuartierJson}]]*/ {};

    var categorieLabels = Object.keys(categoriesData);
    var categorieValues = Object.values(categoriesData);

    var quartierLabels = Object.keys(quartiersData);
    var quartierValues = Object.values(quartiersData);

    // BAR CHART
    new Chart(document.getElementById('categorieChart'), {
        type: 'bar',
        data: {
            labels: categorieLabels,
            datasets: [{
                label: 'Nombre d\'incidents',
                data: categorieValues,
                backgroundColor: 'rgba(75, 192, 192, 0.6)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // PIE CHART AVEC POURCENTAGE
    new Chart(document.getElementById('quartierChart'), {
        type: 'pie',
        data: {
            labels: quartierLabels,
            datasets: [{
                data: quartierValues,
                backgroundColor: [
                    '#ff6384', '#36a2eb', '#ffce56',
                    '#4bc0c0', '#9966ff', '#ff9f40'
                ]
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    color: '#fff',
                    formatter: (value, ctx) => {
                        let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        return ((value / total) * 100).toFixed(1) + '%';
                    },
                    font: { weight: 'bold' }
                },
                legend: { position: 'bottom' }
            }
        },
        plugins: [ChartDataLabels]
    });

    // EXPORT PDF
    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        const element = document.getElementById('stats-content');

        const canvas = await html2canvas(element, {
            scale: 2
        });

        const imgData = canvas.toDataURL('image/png');

        const imgWidth = 190;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        pdf.text("Statistiques des incidents", 10, 10);
        pdf.addImage(imgData, 'PNG', 10, 20, imgWidth, imgHeight);

        pdf.save("statistiques_incidents.pdf");
    }
    /*]]>*/
</script>

</body>
</html>
